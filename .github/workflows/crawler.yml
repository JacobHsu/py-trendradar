name: News HTML Generator

on:
  schedule:
    # æˆ‘å€‘ä½¿ç”¨çš„æ˜¯ github å®˜æ–¹æä¾›çš„è³‡æºä¾†é€²è¡Œçš„æ¨é€ï¼Œè€Œæ¯å€‹å¸³è™Ÿçš„è³‡æºæ˜¯é™é¡çš„ï¼Œç‚ºäº†ä¸è¢«å®˜æ–¹åˆ¤å®šç‚ºæ¿«ç”¨è€Œé¢è‡¨å°è™Ÿçš„é¢¨éšªï¼Œä¸å»ºè­°æ¯”åŠå°æ™‚æ›´ä½
    # æ¯å¤© 9:00, 12:00, 18:00, 20:00 åŸ·è¡Œ
    - cron: "0 9,12,18,20 * * *" # æ¯å°æ™‚æ•´é»é‹è¡Œä¸€æ¬¡"0 * * * *" æˆ–è€… "*/30 * * * *" (æ¯åŠå°æ™‚åŸ·è¡Œä¸€æ¬¡) æˆ–è€… "*/30 0-14 * * *"(æ¯å¤©æ—©ä¸Š 8 é»åˆ°æ™šä¸Š 10 é»æœŸé–“ï¼Œæ¯åŠå°æ™‚é‹è¡Œä¸€æ¬¡)
  workflow_dispatch:

# æ–°å¢æ¬Šé™è¨­å®š
permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  crawl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.9"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          playwright install --with-deps

      - name: Verify required files
        run: |
          echo "ğŸ” æª¢æŸ¥å¿…éœ€çš„è¨­å®šæª”..."

          if [ ! -f config/config.yaml ]; then
            echo "âŒ éŒ¯èª¤: config/config.yaml æª”æ¡ˆä¸å­˜åœ¨"
            echo "è«‹åƒè€ƒå°ˆæ¡ˆæ–‡ä»¶å»ºç«‹è¨­å®šæª”"
            exit 1
          fi

          if [ ! -f config/frequency_words.txt ]; then
            echo "âŒ éŒ¯èª¤: config/frequency_words.txt æª”æ¡ˆä¸å­˜åœ¨"
            echo "è«‹åƒè€ƒå°ˆæ¡ˆæ–‡ä»¶å»ºç«‹ frequency_words è¨­å®šæª”"
            exit 1
          fi

          echo "âœ… è¨­å®šæª”æª¢æŸ¥é€šé"

      - name: Run crawler
        env:
          GITHUB_ACTIONS: true
        run: python main.py

      - name: Commit and push if changes
        run: |
          git config --global user.name 'GitHub Actions'
          git config --global user.email 'actions@github.com'
          git add -A
          git diff --quiet && git diff --staged --quiet || (git commit -m "Auto update by GitHub Actions at $(TZ=Asia/Shanghai date)" && git push)

  # GitHub Pages éƒ¨ç½²ä»»å‹™
  deploy:
    needs: crawl
    runs-on: ubuntu-latest

    # è¨­å®š Pages éƒ¨ç½²ç’°å¢ƒ
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: main  # ç¢ºä¿ç²å–æœ€æ–°æäº¤çš„å…§å®¹

      - name: Setup Pages
        uses: actions/configure-pages@v3

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v2
        with:
          path: '.'  # ä¸Šå‚³æ•´å€‹å„²å­˜åº«å…§å®¹åˆ° Pages

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v2
